name: Deploy Azure Sentinel KQL Testing Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
  push:
    branches:
      - main
    paths:
      - 'sentinel-kql-queries/terraform/**'
  pull_request:
    branches:
      - main
    paths:
      - 'sentinel-kql-queries/terraform/**'

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: './sentinel-kql-queries/terraform'
  ARM_SKIP_PROVIDER_REGISTRATION: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  checks: write

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    env:
      # Set ARM environment variables for Terraform authentication
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_USE_MSI: false
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Azure Login (for Backend Storage Setup)
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      # Note: This is only used for setting up the Terraform backend storage
      # Terraform itself uses the ARM_* environment variables for authentication
        
    - name: Setup Terraform Backend Storage
      if: github.event.inputs.action == 'apply' || github.event_name == 'push'
      run: |
        # Create resource group for Terraform state if it doesn't exist
        az group create --name terraform-state-rg --location "East US" --output none || true
        
        # Create storage account for Terraform state (with unique suffix)
        STORAGE_ACCOUNT_NAME="sentinelkqlstate${{ github.run_number }}"
        echo "STORAGE_ACCOUNT_NAME=$STORAGE_ACCOUNT_NAME" >> $GITHUB_ENV
        
        # Check if storage account exists, create if not
        if ! az storage account show --name $STORAGE_ACCOUNT_NAME --resource-group terraform-state-rg --output none 2>/dev/null; then
          az storage account create \
            --resource-group terraform-state-rg \
            --name $STORAGE_ACCOUNT_NAME \
            --sku Standard_LRS \
            --location "East US" \
            --allow-blob-public-access false \
            --https-only true \
            --output none
        fi
        
        # Create container for Terraform state
        az storage container create \
          --name tfstate \
          --account-name $STORAGE_ACCOUNT_NAME \
          --auth-mode login \
          --output none || true
          
    - name: Update Backend Configuration
      if: github.event.inputs.action == 'apply' || github.event_name == 'push'
      run: |
        # Update backend.tf with the actual storage account name
        sed -i "s/sentinelkqlstate/sentinelkqlstate${{ github.run_number }}/g" backend.tf
        
    - name: Terraform Init
      run: terraform init
        
    - name: Terraform Format Check
      run: terraform fmt -check -recursive
      continue-on-error: true
      
    - name: Terraform Validate
      run: terraform validate
      
    - name: Create Terraform Variables File
      run: |
        cat > terraform.tfvars << EOF
        project_name = "sentinel-kql-${{ github.event.inputs.environment || 'dev' }}"
        environment = "${{ github.event.inputs.environment || 'dev' }}"
        location = "East US"
        
        tags = {
          Project = "Sentinel KQL Testing"
          Environment = "${{ github.event.inputs.environment || 'dev' }}"
          Owner = "Security Team"
          Purpose = "KQL Query Validation"
          DeployedBy = "GitHub Actions"
          Repository = "${{ github.repository }}"
          RunNumber = "${{ github.run_number }}"
        }
        
        # Cost optimization for automated deployments
        log_analytics_retention_days = 30
        log_analytics_daily_quota_gb = 1
        create_test_vms = true
        vm_size = "Standard_B2s"
        vm_admin_username = "azureuser"
        
        enable_security_center = true
        enable_sentinel = true
        enable_key_vault = true
        enable_network_watcher = true
        enable_vm_insights = true
        enable_flow_logs = false  # Disabled to reduce costs in CI/CD
        enable_auto_shutdown = true
        auto_shutdown_time = "1900"
        
        storage_account_tier = "Standard"
        storage_replication_type = "LRS"
        flow_logs_retention_days = 7
        
        create_sample_analytics_rules = true
        EOF
        
    - name: Terraform Plan
      id: plan
      run: |
        terraform plan -no-color -input=false -out=tfplan 2>&1 | tee plan_output.txt
        echo "plan-exitcode=$?" >> $GITHUB_OUTPUT
      env:
        ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        
    - name: Comment PR with Plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          const planFile = path.join('${{ env.WORKING_DIRECTORY }}', 'plan_output.txt');
          
          try {
            const plan = fs.readFileSync(planFile, 'utf8');
            const maxLength = 65000;
            const truncatedPlan = plan.length > maxLength ? 
              plan.substring(0, maxLength) + '\n\n... (truncated)' : plan;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan for Azure Sentinel KQL Testing Infrastructure
              
              <details>
              <summary>Show Plan</summary>
              
              \`\`\`terraform
              ${truncatedPlan}
              \`\`\`
              </details>
              
              **Environment:** ${{ github.event.inputs.environment || 'dev' }}
              **Action:** Plan Only`
            });
          } catch (error) {
            console.log('Error reading plan file:', error);
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan for Azure Sentinel KQL Testing Infrastructure
              
              ❌ **Error:** Could not read terraform plan output.
              
              Please check the workflow logs for details.
              
              **Environment:** ${{ github.event.inputs.environment || 'dev' }}
              **Action:** Plan Only`
            });
          }
          
    - name: Display Plan Output
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan'
      run: |
        echo "## 📋 Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Action:** Plan Only" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Plan Output:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
        if [ -f "plan_output.txt" ]; then
          head -100 plan_output.txt >> $GITHUB_STEP_SUMMARY
          if [ $(wc -l < plan_output.txt) -gt 100 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "... (output truncated - see full logs above)" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "Plan output file not found" >> $GITHUB_STEP_SUMMARY
        fi
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Plan completed successfully!** Review the changes above." >> $GITHUB_STEP_SUMMARY
        
    - name: Terraform Apply
      if: (github.event.inputs.action == 'apply' || github.event_name == 'push') && github.ref == 'refs/heads/main'
      timeout-minutes: 60
      run: |
        echo "🚀 Deploying Azure Sentinel KQL Testing Infrastructure..."
        terraform apply -auto-approve tfplan
        
        echo "## 🎉 Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "Your Azure Sentinel testing environment is ready for KQL testing!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔗 Quick Access Links:" >> $GITHUB_STEP_SUMMARY
        echo "- **Azure Portal**: https://portal.azure.com" >> $GITHUB_STEP_SUMMARY
        echo "- **Microsoft Sentinel**: Search for 'Microsoft Sentinel' in Azure Portal" >> $GITHUB_STEP_SUMMARY
        echo "- **Log Analytics**: Your workspace will be named \`sentinel-kql-${{ github.event.inputs.environment || 'dev' }}-law-*\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 💡 Next Steps for KQL Testing:" >> $GITHUB_STEP_SUMMARY
        echo "1. Connect to your test VM to generate security events" >> $GITHUB_STEP_SUMMARY
        echo "2. Use the generated events guide: \`sentinel-kql-queries/generate-test-events.md\`" >> $GITHUB_STEP_SUMMARY
        echo "3. Monitor incidents in Sentinel → Incidents tab" >> $GITHUB_STEP_SUMMARY
        echo "4. **When done testing**, manually trigger this workflow with 'destroy' action" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "⚠️ **Remember**: Infrastructure will keep running until you manually destroy it!" >> $GITHUB_STEP_SUMMARY
      env:
        ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        
    - name: Display Terraform Outputs
      if: (github.event.inputs.action == 'apply' || github.event_name == 'push') && github.ref == 'refs/heads/main'
      run: |
        echo "## 📋 Terraform Outputs" >> $GITHUB_STEP_SUMMARY
        terraform output -json | jq -r 'to_entries[] | "| **\(.key)** | \(.value.value) |"' > outputs.txt
        echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        cat outputs.txt >> $GITHUB_STEP_SUMMARY
        
    - name: ⚠️ Manual Destroy Confirmation
      if: github.event.inputs.action == 'destroy'
      run: |
        echo "## 🧹 MANUAL DESTROY REQUESTED" >> $GITHUB_STEP_SUMMARY
        echo "⚠️ **WARNING**: This will permanently delete all Azure Sentinel testing infrastructure!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Resources that will be destroyed:**" >> $GITHUB_STEP_SUMMARY
        echo "- Log Analytics Workspace (including all stored data)" >> $GITHUB_STEP_SUMMARY
        echo "- Microsoft Sentinel configuration and rules" >> $GITHUB_STEP_SUMMARY
        echo "- Virtual Machines and associated resources" >> $GITHUB_STEP_SUMMARY
        echo "- Storage accounts and networking resources" >> $GITHUB_STEP_SUMMARY
        echo "- Key Vault and all stored secrets" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "💰 **Estimated cost savings**: ~$18-27/day" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Proceeding with manual destroy as requested...**" >> $GITHUB_STEP_SUMMARY
        
    - name: Terraform Destroy
      if: github.event.inputs.action == 'destroy'
      timeout-minutes: 60
      run: |
        echo "🧹 Destroying Azure Sentinel KQL Testing Infrastructure..."
        terraform destroy -auto-approve
        
        echo "## 🧹 Infrastructure Destroyed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "✅ All Azure Sentinel testing resources have been deleted." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔄 To redeploy:" >> $GITHUB_STEP_SUMMARY
        echo "1. Run this workflow again with 'apply' action" >> $GITHUB_STEP_SUMMARY
        echo "2. Wait ~10-15 minutes for full deployment" >> $GITHUB_STEP_SUMMARY
        echo "3. Continue KQL testing with fresh environment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "💡 **Note**: All test data and custom configurations are now removed." >> $GITHUB_STEP_SUMMARY
      env:
        ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        TF_VAR_project_name: "sentinel-kql-${{ github.event.inputs.environment || 'dev' }}"
        TF_VAR_environment: "${{ github.event.inputs.environment || 'dev' }}"
        TF_VAR_location: "East US"

    - name: Save Terraform Outputs
      if: (github.event.inputs.action == 'apply' || github.event_name == 'push') && github.ref == 'refs/heads/main'
      run: |
        terraform output -json > terraform_outputs.json
        
    - name: Upload Terraform Outputs
      if: (github.event.inputs.action == 'apply' || github.event_name == 'push') && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-outputs-${{ github.event.inputs.environment || 'dev' }}-${{ github.run_number }}
        path: ${{ env.WORKING_DIRECTORY }}/terraform_outputs.json
        retention-days: 30
        
    - name: Post-deployment validation
      if: (github.event.inputs.action == 'apply' || github.event_name == 'push') && github.ref == 'refs/heads/main'
      run: |
        echo "🎉 Azure Sentinel KQL Testing Infrastructure deployed successfully!"
        echo ""
        echo "Next Steps:"
        echo "1. Access your Sentinel workspace using the URLs from outputs"
        echo "2. Wait 10-15 minutes for initial data ingestion"
        echo "3. Test KQL queries in Log Analytics workspace"
        echo "4. Review the sample analytics rules in Sentinel"
        echo ""
        echo "⚠️  Remember: This infrastructure incurs costs (~$18-27/day)"
        echo "Use the 'destroy' action when testing is complete"

  cost-estimate:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'apply'
    steps:
    - name: Cost Estimation Warning
      run: |
        echo "## 💰 Cost Estimation" >> $GITHUB_STEP_SUMMARY
        echo "**Estimated daily costs for testing environment:**" >> $GITHUB_STEP_SUMMARY
        echo "- Log Analytics Workspace: ~$2-5/day (1GB quota)" >> $GITHUB_STEP_SUMMARY
        echo "- Windows VM (Standard_B2s): ~$15-20/day" >> $GITHUB_STEP_SUMMARY
        echo "- Storage & Networking: ~$1-2/day" >> $GITHUB_STEP_SUMMARY
        echo "- **Total: ~$18-27/day**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "⚠️ **Cost Control Features:**" >> $GITHUB_STEP_SUMMARY
        echo "- VM auto-shuts down at 7 PM UTC daily" >> $GITHUB_STEP_SUMMARY
        echo "- Log Analytics has 1GB daily quota" >> $GITHUB_STEP_SUMMARY
        echo "- **MANUAL DESTROY ONLY** - No automatic cleanup!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🛑 **Remember to manually destroy when done testing!**" >> $GITHUB_STEP_SUMMARY
        
  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Terraform Security Scan with Checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: ${{ env.WORKING_DIRECTORY }}
        framework: terraform
        output_format: sarif
        output_file_path: checkov-report.sarif
        
    - name: Upload Checkov Results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: checkov-report.sarif
